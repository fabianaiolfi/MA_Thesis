---
title: "Data Analysis and Initial Results"
author: "Fabian Aiolfi"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: "microtype"
mainfont: Times New Roman
bibliography: references.bib
csl: american-journal-of-political-science.csl
classoption: a4paper
lang: en-UK
header-includes:
   - \usepackage{hyperref}
   - \usepackage{setspace}
   - \onehalfspacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Setup
library(tidyverse)
library(here)
library(sf)
library(shiny)
library(lubridate)
library(haven)
library(here)
library(strucchange) # Chow test in MA_Thesis/scripts/preliminary_exploration/02_fom_emigration/04_models.R
library(readxl) # Read in .xls files
library(scales) # This will ensure that numbers on the y-axis are formatted with commas and without scientific notation.
library(plm) # Panel data analysis
library(stargazer) # Exporting nice tables
library(eurostat) # NUTS3 names
library(slider) # Rolling averages

library(knitr)
library(kableExtra)
library(memisc)
library(pandoc)
library(pander)
library(scales)
library(fixest)
library(modelsummary)

options(scipen = 0) # Enable scientific notation
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
load(here("data", "01_anti_incumbent_vote", "ned_v_dem_cee.Rda"))
load(here("data", "02_external_emigration", "nuts3_population.Rda"))
load(here("data", "02_external_emigration", "bg", "bg.Rda"))
load(here("data", "02_external_emigration", "hr", "hr.Rda"))
load(here("data", "02_external_emigration", "ee", "ee.Rda"))
load(here("data", "02_external_emigration", "hu", "hu.Rda"))
load(here("data", "02_external_emigration", "lv", "lv.Rda"))
load(here("data", "02_external_emigration", "lt", "lt.Rda"))
load(here("data", "02_external_emigration", "pl", "pl.Rda"))
load(here("data", "02_external_emigration", "ro", "ro.Rda"))
load(here("data", "02_external_emigration", "sk", "sk.Rda"))
load(here("data", "02_external_emigration", "si", "si.Rda"))
cee_crude_emigration <- bind_rows(bg, ee, hr, hu, lt, lv, pl, ro, si, sk)
cee_crude_emigration <- cee_crude_emigration %>% mutate(country = substr(NUTS_ID, 1, 2))

load(here("data", "01_anti_incumbent_vote", "ned_v_dem_cee.Rda"))
load(here("data", "02_external_emigration", "cee_crude_emigration.Rda"))
load(here("data", "02_external_emigration", "pl", "pl.Rda"))
load(here("data", "03_service_cuts", "pl", "pl_schools.Rda"))
load(here("data", "03_service_cuts", "pl", "pl_hospitals.Rda"))
load(here("data", "03_service_cuts", "pl", "pl_third_places.Rda"))
load(here("data", "03_service_cuts", "pl", "pl_remittances.Rda"))
load(here("data", "03_service_cuts", "pl", "pl_gdp.Rda"))
```

## Introduction
This document provides an overview of the current status of the data analysis and initial results. It starts with an overview of all eleven CEE EU member states. Descriptive statistics display insights into the available data. I then continue by modelling emigration on incumbent vote change using a fixed effects model. Results show that an increase in emigration is associated with a decrease in incumbent vote share.

In a second step I focus on the effects of service cuts in Poland. I again begin with descriptive statistics that provide an overview. Then I model the effects of service cuts on incumbent vote change. Results partially align with what my theory predicts. An increase in the number of children per school and an increase in the number of people per third place is associated with a decrease in incumbent vote share.

\pagebreak

## CEE EU Member States

### Anti-Incumbent Voting: Was the Party Incumbent?
11 CEE EU Member States, NUTS2/3, 1994–2019 (N = 3240)  

```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
ned_v_dem_cee %>% 
  drop_na(vote_change, prev_incumbent) %>% 
  ggplot(aes(x = prev_incumbent, y = vote_change)) +
  geom_boxplot() +
  xlab("") +
  ylab("Change in Vote Share") +
  scale_x_discrete(labels = c("Not Incumbent", "Incumbent")) +
  theme_minimal() +
  coord_flip()
```

Based on this box plot, we can observe that non-incumbent parties tend to increase their vote share compared to the previous election. On the other hand, incumbent parties seem to get punished by the electorate and more often see a decrease in their vote share. This assumption is supported by a t-test, performed below. The t-test displays a statistically significant result for the difference in means.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Split the scores based on the binary_var
group_true <- ned_v_dem_cee$vote_change[ned_v_dem_cee$prev_incumbent == TRUE]
group_false <- ned_v_dem_cee$vote_change[ned_v_dem_cee$prev_incumbent == FALSE]

# Perform the t-test
result <- t.test(group_true, group_false)
result
```

\pagebreak

### External Emigration

**Crude Emigration per 1000 Population at NUTS3 Level**  

This is an overview of the available external emigration data at NUTS3 level (Poland: NUTS2; Slovenia: NUTS1). Please note that the y-axis varies by country, the x-axis however is the same for all countries. This makes a comparison of available data across different countries easier. Of the eleven CEE EU member states, only ten are displayed as Czechia does not provide data solely on external emigration. Each grey line represents a NUTS region. The red line displays the overall trend over all available years and regions within a country.

```{r echo=FALSE, fig.height=8, message=FALSE, warning=FALSE}
ggplot(cee_crude_emigration, aes(x = year, y = emigration_yearly_per_1000, group = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  facet_wrap(~ country,
             scales = "free_y",
             ncol = 2) +
  ylab(" ") +
  xlab(" ") +
  theme_minimal() 
```

\pagebreak

**Model: Emigration and Incumbent Vote Change**  

I model emigration rates on incumbent vote change across all NUTS3 regions in CEE EU member states. First, I calculate a region’s rolling emigration rate average, taking the average from two consecutive years. E.g., a region’s average emigration rate in the year 2010 is the average of the year 2008 and 2009. I do this to smooth out potential outliers and attempt to model a person’s perception of emigration in a region.

I use the NUTS3 region and the year as fixed effects when building the model, accounting for region- and time-specific factors that may confound the results.

```{r echo=FALSE, message=FALSE, warning=FALSE}
average_emigration <- cee_crude_emigration %>%
  arrange(NUTS_ID, year) %>%
  group_by(NUTS_ID) %>%
  mutate(average_emigration = slider::slide_dbl(emigration_yearly_per_1000, mean, .before = 2, .after = -1, .complete = T)) %>%
  ungroup()

anti_incumbent_vote <- ned_v_dem_cee %>% 
  dplyr::filter(prev_incumbent == T) %>%
  left_join(average_emigration, by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>% 
  drop_na(emigration_yearly_per_1000) %>% 
  drop_na(lrgen_fct) %>% 
  mutate(country = str_sub(nuts2016, end = 2))

fe_1 <- feols(vote_change ~
                average_emigration |
                nuts2016 + year,
              data = anti_incumbent_vote)

modelsummary(fe_1, stars = T, gof_omit = "FE|AIC|BIC|RMSE|Std|R2$|R2 Within$")
```



The coefficient is negative, which shows that an increase in the average emigration rate in a NUTS3 region is associated with a decrease in the change of vote share for the incumbent party. This aligns with my theory. The result is statistically significant at the p < 0.1 level. The standard errors are clustered at the NUTS3 level, as observations within a region are more similar to each other than to observations in other regions. The overall model fit is 53.34%. However, the “within” model fit is very low (0.24%), which indicates that average emigration does not explain variation in the dependent variable within each fixed-effects group.

\pagebreak

**Model: Emigration, Incumbent Vote Change and Party Orientation**  

As a small excursion, I use data from the Chapel Hill Expert survey to categorise parties by their overall ideological stance: Left, Centre Left, Centre, Centre Right and Right. I add this new information to the model, which uses Centre as the reference category.

```{r echo=FALSE, message=FALSE, warning=FALSE}
fe_2 <- feols(vote_change ~
                average_emigration + lrgen_fct |
                nuts2016 + year,
              data = anti_incumbent_vote)

modelsummary(fe_2, stars = T, gof_omit = "FE|AIC|BIC|RMSE|Std|R2$|R2 Within$")
```

Average emigration still shows a negative coefficient and is borderline statistically significant. All party coefficients are statistically significant and the overall model fit as well as the “within” model fit have increased. We can also observe that Left parties fare far worse than other parties when emigration increases.

\pagebreak

## Service Cuts in Poland

```{r echo=FALSE, message=FALSE, warning=FALSE}
options(scipen = 999) # Disable scientific notation
```

### Population Statistics

I now focus on service cuts in Poland, starting with the country’s overall population and primary school population. NUTS2 data is used, because Poland only provides data at this level. Each line represents a Polish NUTS2 region, of which there are 16. A plot's overall trend is displayed with a red trendline.

Contrary to my expectations, the overall population has not decreased in the past 20 years. However, the number of primary aged school children, aged seven to twelve, has decreased.

**Entire Population in Poland by NUTS2**  
```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
ggplot(pl, aes(x = year, y = population, group = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```

**Primary Age Population in Poland by NUTS2**  
```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
ggplot(pl_schools, aes(x = year, y = population, line = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```

\pagebreak

### Ratios

Also contrary to my expectations, all services that I investigate generally see a decrease in their ratios. This means that over time, there are less people per institution in a NUTS2 region. E.g., less children in a school or less citizens per hospital.

**Number of Primary School Children per School by NUTS2 in Poland**
  
```{r echo=FALSE, fig.height=2, message=FALSE, warning=FALSE}
ggplot(pl_schools, aes(x = year, y = ratio_schools, line = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```
  
**Number of People per Hospital by NUTS2 in Poland**  
  
```{r echo=FALSE, fig.height=2, message=FALSE, warning=FALSE}
ggplot(pl_hospitals, aes(x = year, y = ratio_hospitals_all_population, line = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```
  
**Number of People per Third Place by NUTS2 in Poland**
  
```{r echo=FALSE, fig.height=2, message=FALSE, warning=FALSE}
ggplot(pl_third_places, aes(x = year, y = ratio_third_places, line = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```

\pagebreak

### Control Variables

Both remittances and GDP show an increase over time. I use these data as control variables in my models. Data on remittances are only available at the national level.

**Remittance Inflows (US$ million) for all of Poland**  
```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
ggplot(pl_remittances, aes(x = year, y = remittances)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```

**GDP at Current Market Prices in Poland by NUTS 2 (Euros per Inhabitant)**  
```{r echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
ggplot(pl_gdp, aes(x = year, y = gdp, line = NUTS_ID)) +
  geom_line(color = "light grey") +
  geom_smooth(aes(group = 1), method = "lm", color = "red", se = FALSE, size = 0.5) + 
  scale_y_continuous(labels = label_comma()) + ylab("") + xlab("") + theme_minimal()
```

\pagebreak

```{r echo=FALSE, message=FALSE, warning=FALSE}
options(scipen = 0) # Enable scientific notation

# Calculate the average crude_net_migration for each NUTS_ID for every pair of consecutive years
average_emigration <- pl %>%
  arrange(NUTS_ID, year) %>%
  group_by(NUTS_ID) %>%
  # Take rolling average of past 2 years into account, ignore current year
  mutate(average_emigration = slider::slide_dbl(emigration_yearly_per_1000, mean, .before = 2, .after = -1, .complete = T)) %>%
  ungroup()

anti_incumbent_vote <- ned_v_dem_cee %>% 
  dplyr::filter(prev_incumbent == T) %>%
  left_join(average_emigration, by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>% 
  drop_na(emigration_yearly_per_1000)

anti_incumbent_vote <- anti_incumbent_vote %>% 
  left_join(dplyr::select(pl_schools, -population), by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>%
  left_join(dplyr::select(pl_hospitals, -population), by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>% 
  left_join(dplyr::select(pl_third_places, -population), by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>% 
  left_join(pl_remittances, by = "year") %>% 
  left_join(pl_gdp, by = c("year" = "year", "nuts2016" = "NUTS_ID")) %>% 
  dplyr::filter(nuts2016 != "PL91") # Remove potentially problematic NUTS2 region (Warszawski stołeczny)

fe_lm_1 <- feols(vote_change ~
                   ratio_schools +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_2 <- feols(vote_change ~
                   ratio_hospitals_all_population +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_3 <- feols(vote_change ~
                   ratio_third_places +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_4 <- feols(vote_change ~
                   ratio_schools +
                   ratio_hospitals_all_population +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_5 <- feols(vote_change ~
                   ratio_schools +
                   ratio_third_places +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_6 <- feols(vote_change ~
                   ratio_hospitals_all_population +
                   ratio_third_places +
                   emigration_election_year_per_1000 +
                   remittances +
                   gdp | 
                   nuts2016 + year,
                 data = anti_incumbent_vote)

fe_lm_7 <- feols(vote_change ~
                ratio_schools +
                ratio_hospitals_all_population +
                ratio_third_places +
                emigration_election_year_per_1000 +
                remittances +
                gdp | 
                nuts2016 + year,
              data = anti_incumbent_vote)
```

### LM Models: Anti-Incumbent Voting in Poland at NUTS2 Level

```{r echo=FALSE, message=FALSE, warning=FALSE}
modelsummary(list(fe_lm_1, fe_lm_2, fe_lm_3), stars = T)
```

I first model separate ratios on incumbent vote change while controlling for emigration and GDP. Models 1, 2 and 3 each use a ratio separately. NUTS2 regions and years are used as fixed effects in all models. The emigration rate is the rolling emigration average between two national elections. Remittances are removed due to collinearity.

Some coefficients point in the right direction but overall no results are statistically significant at conventional levels. An increase in the number of children per school is associated with a decrease in the incumbent vote share. However the p-value is high ($p = 0.197$). Both hospital and third places ratios have coefficients of 0, displaying no effect on incumbent vote share.

\pagebreak

```{r echo=FALSE, message=FALSE, warning=FALSE}
modelsummary(list(fe_lm_4, fe_lm_5, fe_lm_6, fe_lm_7), stars = T)
```

In a second step, I use different combinations of ratios (models 1, 2 and 3) and finally combine all ratios in model 4. Again, NUTS2 regions and years are used as fixed effects. Both school ratio and third places ratio display statistically significant and negative coefficients, which align with my theory. This means that an increase in the number of children per school and an increase of the number of people per third place is associated with a decrease in the incumbent vote share, while controlling for emigration and GDP. The third ratio, number of people per hospital, still shows no effect.

\pagebreak

## Sources
…